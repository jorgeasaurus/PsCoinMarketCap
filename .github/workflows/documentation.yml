name: Documentation

permissions:
    contents: write

on:
  push:
    branches: [ main ]
    paths:
      - 'Source/**/*.ps1'
      - 'Source/**/*.psd1'
      - 'docs/**'
      - 'README.md'
      - 'CHANGELOG.md'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'Source/**/*.ps1'
      - 'Source/**/*.psd1'
      - 'docs/**'
      - 'README.md'
  workflow_dispatch:

env:
  MODULE_NAME: PsCoinMarketCap
  POWERSHELL_TELEMETRY_OPTOUT: 1

jobs:
  generate-docs:
    name: Generate Documentation
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install PowerShell modules
      shell: pwsh
      run: |
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
        Install-Module -Name platyPS -Force -Scope CurrentUser -SkipPublisherCheck
        Install-Module -Name ImportExcel -Force -Scope CurrentUser -ErrorAction SilentlyContinue

    - name: Import module and generate help
      shell: pwsh
      run: |
        Write-Host "ðŸ”§ Importing module and generating documentation..." -ForegroundColor Cyan
        
        # Import the module
        Import-Module ./Source/${{ env.MODULE_NAME }}.psd1 -Force
        
        # Verify module loaded
        $module = Get-Module ${{ env.MODULE_NAME }}
        if (-not $module) {
          Write-Error "âŒ Failed to import module"
          exit 1
        }
        
        Write-Host "âœ… Module imported: $($module.Name) v$($module.Version)" -ForegroundColor Green
        Write-Host "ðŸ“Š Functions exported: $($module.ExportedFunctions.Count)" -ForegroundColor White

    - name: Generate platyPS documentation
      shell: pwsh
      run: |
        Write-Host "ðŸ“š Generating platyPS documentation..." -ForegroundColor Cyan
        
        # Create docs directory structure
        $docsPath = "./docs"
        $helpPath = "$docsPath/Help"
        $functionsPath = "$helpPath/Functions"
        $platypsPpath = "$docsPath/en-US"
        
        @($docsPath, $helpPath, $functionsPath, $platypsPpath) | ForEach-Object {
          if (-not (Test-Path $_)) {
            New-Item -Path $_ -ItemType Directory -Force | Out-Null
          }
        }
        
        # Generate markdown help for all functions using platyPS
        $module = Get-Module ${{ env.MODULE_NAME }}
        
        try {
          # Generate help for each command using platyPS
          Write-Host "ðŸ“ Generating platyPS help files..." -ForegroundColor Yellow
          New-MarkdownHelp -Module ${{ env.MODULE_NAME }} -OutputFolder $platypsPpath -WithModulePage -Force
          
          # Generate external help file
          New-ExternalHelp -Path $platypsPpath -OutputPath "./Source/en-US" -Force
          
          Write-Host "âœ… platyPS documentation generated successfully" -ForegroundColor Green
        }
        catch {
          Write-Warning "platyPS generation failed: $_"
          Write-Host "Falling back to custom help generation..." -ForegroundColor Yellow
        }

    - name: Generate custom documentation
      shell: pwsh
      run: |
        Write-Host "ðŸ“‹ Generating custom documentation..." -ForegroundColor Cyan
        
        $module = Get-Module ${{ env.MODULE_NAME }}
        $functions = $module.ExportedFunctions.Keys | Sort-Object
        
        # Create function categories
        $authFunctions = $functions | Where-Object { $_ -like "*ApiKey*" }
        $cryptoFunctions = $functions | Where-Object { $_ -like "Get-CMC*" -and $_ -notlike "*Exchange*" -and $_ -notlike "*Global*" -and $_ -notlike "*ApiKey*" -and $_ -notlike "*Rate*" }
        $globalFunctions = $functions | Where-Object { $_ -like "*Global*" }
        $toolsFunctions = $functions | Where-Object { $_ -in @('Convert-CMCPrice', 'Export-CMCData', 'Watch-CMCPrice', 'Get-CMCChart') }
        $exchangeFunctions = $functions | Where-Object { $_ -like "*Exchange*" }
        $rateFunctions = $functions | Where-Object { $_ -like "*Rate*" -or $_ -like "Invoke-*" }
        
        # Generate function lists
        $authList = ($authFunctions | ForEach-Object { "- [$_](en-US/$_.md)" }) -join "`n"
        $cryptoList = ($cryptoFunctions | ForEach-Object { "- [$_](en-US/$_.md)" }) -join "`n"
        $globalList = ($globalFunctions | ForEach-Object { "- [$_](en-US/$_.md)" }) -join "`n"
        $toolsList = ($toolsFunctions | ForEach-Object { "- [$_](en-US/$_.md)" }) -join "`n"
        $exchangeList = ($exchangeFunctions | ForEach-Object { "- [$_](en-US/$_.md)" }) -join "`n"
        $rateList = ($rateFunctions | ForEach-Object { "- [$_](en-US/$_.md)" }) -join "`n"
        
        # Generate function table
        $functionTable = $functions | ForEach-Object {
          $functionName = $_
          $category = "Other"
          if ($_ -like "*ApiKey*") { $category = "Authentication" }
          elseif ($_ -like "Get-CMCListings" -or $_ -like "Get-CMCQuotes" -or $_ -like "Get-CMCInfo" -or $_ -like "Get-CMCMap") { $category = "Cryptocurrency" }
          elseif ($_ -like "*Global*") { $category = "Global Metrics" }
          elseif ($_ -in @('Convert-CMCPrice', 'Export-CMCData', 'Watch-CMCPrice', 'Get-CMCChart')) { $category = "Tools & Utilities" }
          elseif ($_ -like "*Exchange*") { $category = "Exchange Data" }
          elseif ($_ -like "*Rate*" -or $_ -like "Invoke-*") { $category = "Rate Limiting" }
          
          $synopsis = "PowerShell cmdlet"
          try {
            $help = Get-Help $_ -ErrorAction SilentlyContinue
            if ($help.Synopsis -and $help.Synopsis -ne $_) {
              $synopsis = if ($help.Synopsis.Length -gt 80) { $help.Synopsis.Substring(0, 77) + "..." } else { $help.Synopsis }
            }
          } catch {
            # Use default synopsis
          }
          
          "| [$_](en-US/$_.md) | $synopsis | $category |"
        }
        $functionTableText = $functionTable -join "`n"
        
        # Generate comprehensive module help
        $moduleHelp = @"
        # ${{ env.MODULE_NAME }} PowerShell Module

        **Version:** $($module.Version)  
        **Author:** $($module.Author)  
        **Generated:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

        ## Description
        $($module.Description)

        ## Installation

        ### From PowerShell Gallery
        ``````powershell
        Install-Module -Name ${{ env.MODULE_NAME }}
        Import-Module ${{ env.MODULE_NAME }}
        ``````

        ### From Source
        ``````powershell
        git clone https://github.com/jorgeasaurus/${{ env.MODULE_NAME }}.git
        Import-Module ./${{ env.MODULE_NAME }}/Source/${{ env.MODULE_NAME }}.psd1
        ``````

        ## Quick Start

        ``````powershell
        # Set up your API key
        Set-CMCApiKey -ApiKey "your-api-key-here"

        # Get top 10 cryptocurrencies
        Get-CMCListings -Limit 10

        # Get Bitcoin price
        Get-CMCQuotes -Symbol "BTC"

        # Monitor prices with alerts
        Watch-CMCPrice -Symbol "BTC" -AlertAbove 50000
        ``````

        ## Available Functions

        This module exports **$($functions.Count) functions** organized by category:

        ### Authentication
        $authList

        ### Cryptocurrency Data
        $cryptoList

        ### Global Metrics
        $globalList

        ### Tools & Utilities
        $toolsList

        ### Exchange Data
        $exchangeList

        ### Rate Limiting & Utilities
        $rateList

        ## Complete Function List

        | Function | Synopsis | Category |
        |----------|----------|----------|
        $functionTableText

        ## Additional Resources

        - [API Reference Guide](API_REFERENCE.md) - Comprehensive API documentation
        - [Free Tier Guide](FREE_TIER_GUIDE.md) - Maximizing free tier usage
        - [Deployment Guide](../DEPLOYMENT_GUIDE.md) - Module deployment and distribution
        - [Changelog](../CHANGELOG.md) - Version history and release notes
        - [GitHub Repository](https://github.com/jorgeasaurus/${{ env.MODULE_NAME }})
        - [CoinMarketCap API Documentation](https://coinmarketcap.com/api/documentation/v1/)

        ## Support

        - ðŸ› **Issues**: [GitHub Issues](https://github.com/jorgeasaurus/${{ env.MODULE_NAME }}/issues)
        - ðŸ’¬ **Discussions**: [GitHub Discussions](https://github.com/jorgeasaurus/${{ env.MODULE_NAME }}/discussions)
        - ðŸ“– **Documentation**: Complete guides in the [docs folder](.)

        ## License

        This project is licensed under the MIT License - see the [LICENSE](../LICENSE) file for details.
        "@
        
        $moduleHelp | Out-File -FilePath "./docs/Help/${{ env.MODULE_NAME }}-Help.md" -Encoding UTF8

    - name: Validate generated documentation
      shell: pwsh
      run: |
        Write-Host "âœ… Validating generated documentation..." -ForegroundColor Cyan
        
        $helpPath = "./docs"
        $platypspath = "./docs/en-US"
        
        # Check if platyPS help files were generated
        $platypsFiles = 0
        if (Test-Path $platypspath) {
          $platypsFiles = (Get-ChildItem $platypspath -Filter "*.md" | Measure-Object).Count
        }
        
        # Check if main help file was generated
        $mainHelp = "./docs/Help/${{ env.MODULE_NAME }}-Help.md"
        $mainHelpExists = Test-Path $mainHelp
        
        Write-Host "ðŸ“Š Documentation Statistics:" -ForegroundColor Cyan
        Write-Host "  platyPS Help Files: $platypsFiles" -ForegroundColor White
        Write-Host "  Main Help File: $(if($mainHelpExists){'âœ… Generated'}else{'âŒ Missing'})" -ForegroundColor White
        Write-Host "  API Reference: $(if(Test-Path './docs/API_REFERENCE.md'){'âœ… Present'}else{'âŒ Missing'})" -ForegroundColor White
        Write-Host "  Free Tier Guide: $(if(Test-Path './docs/FREE_TIER_GUIDE.md'){'âœ… Present'}else{'âŒ Missing'})" -ForegroundColor White
        
        if ($platypsFiles -gt 0 -or $mainHelpExists) {
          Write-Host "âœ… Documentation generation successful!" -ForegroundColor Green
        } else {
          Write-Warning "âš ï¸  Documentation generation may have issues"
        }

    - name: Clean up
      shell: pwsh
      run: |
        # Remove imported module
        Remove-Module ${{ env.MODULE_NAME }} -Force -ErrorAction SilentlyContinue

    - name: Commit and push documentation
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/ Source/en-US/
        git diff --staged --quiet || git commit -m "ðŸ“š Auto-update documentation [skip ci]"
        git push

    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: |
          docs/
          Source/en-US/
        retention-days: 30

  build-docs-site:
    name: Build Documentation Site
    runs-on: ubuntu-latest
    needs: generate-docs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download documentation artifacts
      uses: actions/download-artifact@v4
      with:
        name: documentation
        path: ./

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Create documentation site
      run: |
        # Debug: Show current directory and contents
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        
        # Create _site directory for GitHub Pages
        mkdir -p _site
        
        # Copy essential files to _site
        if [ -d "docs" ]; then cp -r docs _site/; fi
        if [ -f "README.md" ]; then cp README.md _site/; fi
        if [ -f "CHANGELOG.md" ]; then cp CHANGELOG.md _site/; fi
        if [ -f "LICENSE" ]; then cp LICENSE _site/; fi
        for png in *.png; do
          [ -f "$png" ] && cp "$png" _site/
        done
        
        # Create Jekyll config in _site
        cd _site
        cat > _config.yml << 'EOF'
        theme: jekyll-theme-minimal
        title: PsCoinMarketCap
        description: ðŸš€ PowerShell module for CoinMarketCap API v1 - Cryptocurrency data, monitoring, and analysis tools
        logo: PsCoinMarketCap_Logo.png
        show_downloads: true
        github:
          repository_url: https://github.com/jorgeasaurus/PsCoinMarketCap
        plugins:
          - jekyll-sitemap
          - jekyll-feed
        include:
          - docs
          - README.md
          - CHANGELOG.md
          - LICENSE
        exclude:
          - Source/
          - Tests/
          - Build/
          - .github/
        markdown: kramdown
        highlighter: rouge
        EOF
        
        # Create enhanced index page (still in _site directory)
        cat > index.md << 'EOF'
        ---
        layout: default
        title: Home
        ---

        # ðŸš€ PsCoinMarketCap

        ### ðŸ’Ž A PowerShell module for the CoinMarketCap API

        [![PowerShell](https://img.shields.io/badge/PowerShell-5.1%2B-blue.svg)](https://github.com/PowerShell/PowerShell)
        [![API Version](https://img.shields.io/badge/CMC%20API-v1-green.svg)](https://coinmarketcap.com/api/documentation/v1/)
        [![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

        ## Quick Links

        - ðŸ“– **[Complete Documentation](docs/Help/PsCoinMarketCap-Help.html)** - Full module documentation
        - ðŸš€ **[API Reference](docs/API_REFERENCE.html)** - Comprehensive command reference  
        - ðŸ’Ž **[Free Tier Guide](docs/FREE_TIER_GUIDE.html)** - Maximizing free API usage
        - ðŸ“ **[Changelog](CHANGELOG.html)** - Version history and release notes
        - ðŸ”§ **[Deployment Guide](DEPLOYMENT_GUIDE.html)** - Installation and setup

        ## Installation

        ```powershell
        Install-Module -Name PsCoinMarketCap
        ```

        ## Quick Start

        ```powershell
        # Set up API key
        Set-CMCApiKey -ApiKey "your-api-key-here"

        # Get top 10 cryptocurrencies
        Get-CMCListings -Limit 10

        # Monitor Bitcoin with alerts
        Watch-CMCPrice -Symbol "BTC" -AlertAbove 50000
        ```

        ## Features

        - ðŸ” **Secure API Key Management** - Encrypted storage and session management
        - ðŸ“ˆ **Real-time Data** - Current prices, market caps, and trading volumes  
        - ðŸŒ **Global Metrics** - Overall market statistics and trends
        - ðŸ’± **Price Conversion** - Convert between 100+ currencies
        - âš¡ **Rate Limiting** - Built-in rate limit tracking and management
        - ðŸ“Š **Advanced Tools** - Monitoring, reporting, charts, and data export
        - ðŸ§ª **Comprehensive Testing** - 95+ unit tests with extensive coverage

        Explore the complete documentation to discover all features and capabilities!
        EOF
        
        # Convert markdown files to be Jekyll-compatible (we're in _site directory)
        find . -name "*.md" -type f | while read -r file; do
          # Add Jekyll front matter if not present
          if ! head -n 1 "$file" | grep -q "^---"; then
            title=$(basename "$file" .md | sed 's/_/ /g' | sed 's/\b\w/\U&/g')
            temp_file=$(mktemp)
            echo "---" > "$temp_file"
            echo "layout: default" >> "$temp_file"
            echo "title: $title" >> "$temp_file"
            echo "---" >> "$temp_file"
            echo "" >> "$temp_file"
            cat "$file" >> "$temp_file"
            mv "$temp_file" "$file"
          fi
        done
        
        # Go back to repository root
        cd ..
        
        # Create a simple index.html as fallback
        if [ ! -f "_site/index.html" ]; then
          cat > _site/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsCoinMarketCap Documentation</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { color: #0366d6; }
        pre { background: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto; }
        code { background: #f6f8fa; padding: 2px 4px; border-radius: 3px; }
        .buttons { margin: 20px 0; }
        .buttons a { display: inline-block; padding: 10px 20px; margin-right: 10px; background: #0366d6; color: white; text-decoration: none; border-radius: 6px; }
        .buttons a:hover { background: #0256c7; }
    </style>
</head>
<body>
    <h1>ðŸš€ PsCoinMarketCap</h1>
    <h2>PowerShell Module for CoinMarketCap API</h2>
    
    <div class="buttons">
        <a href="https://github.com/jorgeasaurus/PsCoinMarketCap">GitHub Repository</a>
        <a href="README.html">README</a>
        <a href="CHANGELOG.html">Changelog</a>
        <a href="docs/Help/PsCoinMarketCap-Help.html">Documentation</a>
    </div>
    
    <h3>Installation</h3>
    <pre><code>Install-Module -Name PsCoinMarketCap</code></pre>
    
    <h3>Quick Start</h3>
    <pre><code># Set API Key
Set-CMCApiKey -ApiKey "your-api-key"

# Get top cryptocurrencies  
Get-CMCListings -Limit 10

# Get Bitcoin price
Get-CMCQuotes -Symbol "BTC"</code></pre>
    
    <p>For full documentation, see the <a href="docs/Help/PsCoinMarketCap-Help.html">module help</a>.</p>
</body>
</html>
EOF
        fi
        
        # Debug: Show _site contents
        echo "ðŸ“„ Documentation site prepared with Jekyll in _site directory"
        echo "_site directory contents:"
        ls -la _site/
        echo "Total files in _site:"
        find _site -type f | wc -l

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./_site

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  notify-completion:
    name: Notify Documentation Update
    runs-on: ubuntu-latest
    needs: [generate-docs, build-docs-site]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Create summary
      run: |
        echo "ðŸ“š Documentation update completed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Generated Documentation" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”§ Function reference updated with platyPS" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“– Help files regenerated" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ GitHub Pages deployed with Jekyll" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Links" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“– Documentation Site](https://jorgeasaurus.github.io/PsCoinMarketCap)" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸš€ API Reference](docs/API_REFERENCE.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ’Ž Free Tier Guide](docs/FREE_TIER_GUIDE.md)" >> $GITHUB_STEP_SUMMARY